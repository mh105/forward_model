#!/bin/sh
#
#
#   Organize the MRI data
#
#   Create a directory structure according to the series and subseries (different echos for flashes)
#       
#   Copyright 2006
#
#   Matti Hamalainen
#   Athinoula A. Martinos Center for Biomedical Imaging
#   Massachusetts General Hospital
#   Charlestown, MA, USA
#
#   $Id: mne_organize_dicom 3162 2010-04-23 22:27:07Z msh $
#
#   Revision 1.1  2006/05/16 02:29:49  msh
#   Added mne_flash_bem and mne_organize_dicom
#
#
#
function cleanup()
{
    rm -f $$.dir
    rm -f $$.one
    rm -f $$.script
    exit 0
}
echoit=/bin/echo
#
trap cleanup 1 2
#
if [ $# -eq 0 ]
then
    $echoit "Usage : $0 <Slice directory>"
    exit 1
fi
if [ ! -d $1 ]
then 
    $echoit "$1 is not a directory"
    exit 1
fi
find $1 -follow -type f > $$.dir
$echoit -n "Figuring it all out. Please wait.."
#
# Read the filenames and proceed accordingly
#
tot=$(wc -l $$.dir | awk '{ print $1 }')
i=0
while read filename
do
  $echoit -n "$filename " >$$.one
  mne_dicom_essentials  --in $filename >>$$.one
  awk 'BEGIN { printf "#!/bin/sh\n#\n" }; { printf "mkdir -p %03d_%s/%03d\ncd %03d_%s/%03d\nln -s ../../%s .\ncd - >/dev/null\n", $3,$11,$15+1,$3,$11,$15+1,$1} ' < $$.one > $$.script
  chmod +x $$.script
  ./$$.script
  let i=$i+1
  let a=$i%50
  if [ $a -eq 0 ]
  then
      $echoit -n "$i/$tot.."
  fi
done < $$.dir
$echoit "$i/$tot...[done]"
cleanup
exit 0


